<!DOCTYPE html>
<html>
  <head>
    <title>ProjectTwo</title>
    <%= stylesheet_link_tag    'application', media: 'all', 'data-turbolinks-track' => true %>
    <%= javascript_include_tag 'application', 'data-turbolinks-track' => true %>
  </head>
  <body>
    <script>
      var getAverageVolume = function(array) {
        var values = 0;
        var average;

        var length = array.length;

        // get all the frequency amplitudes
        for (var i = 0; i < length; i++) {
            values += array[i];
        }

        average = values / length;
        return average;
      } 

      var scene = new THREE.Scene();
      var camera = new THREE.PerspectiveCamera( 25, window.innerWidth/window.innerHeight, 0.1, 1000 );

      var renderer = new THREE.WebGLRenderer();
      renderer.setSize( window.innerWidth, window.innerHeight );
      document.body.appendChild( renderer.domElement );

      camera.position.z = 10;
      var ballCount = 0; //counter for spheres
      var i = 0; //counter for hue
      var j = 0; //counter for freq channel

      function empty(elem) {
      while (elem.lastChild) elem.removeChild(elem.lastChild);
}

      var render = function () {

        if (music_playing) {
          // Throttle frame rate
          setTimeout( function() {
            zensationAnimation = requestAnimationFrame( render );
          }, 1000 / 30 );
        } else {
          cancelAnimationFrame(zensationAnimation);// Stop the animation
        }

        // Define circle
        var radius = 2,
        segments = 64,
        material = new THREE.LineBasicMaterial( { color: 0x000000 } ),
        geometry = new THREE.CircleGeometry( radius, segments );
        // Remove center vertex
        geometry.vertices.shift();
        // to work with MeshBasicMaterial
        circle = new THREE.Line( geometry, material )

        // Setting colour twice - Ineffient
        // You can do this directly without pusher - see setHSL in three.js
        var color = pusher.color('hsv', [Math.round(i), 70, 100]).hex6();
        circle.material.color.setHex( color );
        i += 0.1;

        // Mouse interaction
        circle.position.x = 8 * (mousePosition.x / window.innerWidth - 0.5);
        circle.position.y = -8 * (mousePosition.y / window.innerHeight - 0.5);
        circle.position.z = 2;

        scene.traverse (function (object)
        {
          if (object instanceof THREE.Line) {

            var sensitivity = 1
            
            // Cycle through colours
            var hsl = object.material.color.getHSL();
            var averageVolume = getAverageVolume(frequencyAmplitudeArray);
            var musicIntensity = Math.pow(averageVolume/255, sensitivity);
            object.material.color.setHSL(hsl.h, musicIntensity, hsl.l);

            // Move circle further back
            object.position.z -= musicIntensity / 2 ;

            // Pulse to the music
            // Dealing with small numbers because circles are very sensitive
            // to changes in size
            var scaleFactor = frequencyAmplitudeArray[j % frequencyAmplitudeArray.length]/25500;
            object.scale.x *= scaleFactor * 2 + 0.995;
            object.scale.y *= scaleFactor * 2 + 0.995;
            j++;

            // Rotate rings
            circle.rotation.x += 0.1;
            circle.rotation.y += 0.01;

            // Make objects in the distance darker
            object.material.color.offsetHSL(0,0, -0.003);

          };
        });

        // Don't add a new circle if music is not playing
        if (getAverageVolume(frequencyAmplitudeArray)) {
          scene.add( circle );
          ballCount++;
        };

        renderer.render(scene, camera);
      };

    </script>
    <div class="container">
      <div class="row">
        <h3 class="white zensations">Zensation<span class="mirror-letter">Z</span></h3>
        <a class="show" style="color:#999;">>>></a>
      </div>
    </div>

    <div id="slide-menu">
    <div class="container">
      <div class="flex flex-stretch mxn4">
        <div class="col col-4 px2 border border-grey">
          <h2>Music</h2>
          <form id="form">
            <label for="input">Paste Soundcloud URL here</label>
            <input id="input" class="block full-width field-light" placeholder="https://soundcloud.com/jrhodespianist/chopin-nocturne-in-c-minor-opus-481">
            <p>
              <button type="submit" id="submit" class="button black bg-silver mb1">Play it!</button>
              &nbsp;
              <input type="button" id="stop" value="Stop" class="button black bg-silver mb1">
            </p>
          </form>
        </div>
        <div class="col col-4 px2 border border-grey">
          <h2>Visualisations</h2>
        </div>
        <div class="col col-4 px2 border border-grey">
          <h2>Sign Up</h2>
          <h2>Log In</h2>
        </div>
      </div>
    </div>
    </div>
      <footer class="navbar navbar-fixed-bottom" id="footer">
        <div class="navbar-inner">
            <div class="container">
              <button data-target=".show-footer" data-toggle="collapse" class="btn btn-navbar"
                type="button" id="footer_btn">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
                <div class="nav-collapse collapse show-footer" id="footer_body">
                    <nav>
                        <ul class="nav pull-right">
                            <li><a href="/about">About</a>

                            </li>
                            <li><a href="/contact">Contact</a>

                            </li>
                            <li><a href="/faq">FAQ</a>

                            </li>
                            <li><a href="/careers">Careers</a>

                            </li>
                            <li><a href="/privacy">Privacy</a>

                            </li>
                            <li><a href="/quotes">Quotes</a>

                            </li>
                            <li><a href="/terms">Terms</a>

                            </li>
                            <li><a target="_blank" href="http://news.railstutorial.org/">News</a>

                            </li>
                        </ul>
                    </nav>
                </div>
                <!--/.nav-collapse -->
            </div>
        </div>
    </footer>

  </body>
</html>
